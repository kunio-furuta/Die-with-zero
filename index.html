<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ€ã‚¤ãƒ»ã‚¦ã‚£ã‚ºãƒ»ã‚¼ãƒ­</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
    background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
    min-height: 100vh; color: #fff; padding: 20px;
  }
  .header { text-align: center; padding: 30px 0 20px; }
  .header h1 {
    font-size: 2.2rem; font-weight: 900;
    background: linear-gradient(90deg, #f7971e, #ffd200);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header p { color: #aaa; margin-top: 8px; font-size: 0.9rem; }
  .container { max-width: 1100px; margin: 0 auto; }

  .save-bar { display: flex; align-items: center; justify-content: flex-end; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
  .btn-save { background: linear-gradient(90deg, #f7971e, #ffd200); border: none; border-radius: 10px; color: #1a1a2e; font-weight: 700; font-size: 0.9rem; padding: 10px 22px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
  .btn-save:hover { opacity: 0.85; }
  .save-url-box { display: none; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,210,0,0.4); border-radius: 10px; padding: 10px 14px; font-size: 0.8rem; color: #ffd200; word-break: break-all; margin-bottom: 8px; }
  .save-url-box.show { display: block; }
  .btn-copy { background: rgba(255,210,0,0.15); border: 1px solid rgba(255,210,0,0.4); color: #ffd200; border-radius: 8px; padding: 6px 14px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; }
  .save-toast { display: none; background: rgba(81,207,102,0.2); border: 1px solid rgba(81,207,102,0.5); color: #51cf66; border-radius: 8px; padding: 8px 16px; font-size: 0.85rem; }
  .save-toast.show { display: inline-block; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  @media (max-width: 700px) {
    .grid { grid-template-columns: 1fr; }
    .summary { grid-template-columns: 1fr 1fr !important; }
    .header h1 { font-size: 1.6rem; }
    .save-bar { justify-content: center; }
  }
  .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; }
  .card h2 { font-size: 1rem; color: #ffd200; margin-bottom: 16px; }
  .form-group { margin-bottom: 14px; }
  label { display: block; font-size: 0.8rem; color: #bbb; margin-bottom: 4px; }
  .input-wrap { position: relative; }
  .input-wrap .unit { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #888; font-size: 0.8rem; pointer-events: none; }
  input.comma-input, input.plain-input {
    width: 100%; padding: 9px 36px 9px 12px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.08); color: #fff;
    font-size: 0.95rem; outline: none; text-align: right;
  }
  input.comma-input:focus, input.plain-input:focus { border-color: #ffd200; }

  /* å¯¿å‘½æ¬„ã‚’ç›®ç«‹ãŸã›ã‚‹ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  input.life-input {
    width: 100%; padding: 9px 36px 9px 12px; border-radius: 8px;
    border: 1px solid rgba(255,107,107,0.5);
    background: rgba(255,107,107,0.08); color: #fff;
    font-size: 1rem; font-weight: 700; outline: none; text-align: right;
  }
  input.life-input:focus { border-color: #ff6b6b; box-shadow: 0 0 0 2px rgba(255,107,107,0.2); }

  input[type="text"].name-input { width: 100%; padding: 9px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #fff; font-size: 0.95rem; outline: none; }
  input[type="text"].name-input:focus { border-color: #ffd200; }

  .side-job-section { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; margin-top: 12px; }
  .side-job-section h3 { font-size: 0.85rem; color: #74c0fc; margin-bottom: 12px; }
  .age-range { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .extra-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
  .extra-item .name-input { flex: 1.5; }
  .extra-item .comma-wrap { flex: 1; position: relative; }
  .extra-item .comma-wrap input { width: 100%; padding: 9px 30px 9px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #fff; font-size: 0.95rem; outline: none; text-align: right; }
  .extra-item .comma-wrap input:focus { border-color: #ffd200; }
  .extra-item .comma-wrap .unit { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #888; font-size: 0.75rem; pointer-events: none; }
  .btn-del { background: rgba(255,80,80,0.3); border: none; color: #ff8080; border-radius: 8px; padding: 0 12px; cursor: pointer; font-size: 1rem; height: 38px; }
  .btn-del:hover { background: rgba(255,80,80,0.6); }
  .btn-add { background: rgba(255,210,0,0.12); border: 1px dashed rgba(255,210,0,0.5); color: #ffd200; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.85rem; width: 100%; margin-top: 4px; }
  .btn-add:hover { background: rgba(255,210,0,0.22); }

  .summary { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 20px; }
  .summary-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 16px; text-align: center; }
  .summary-card.highlight { background: rgba(255,210,0,0.08); border-color: rgba(255,210,0,0.4); }
  .summary-card .slabel { font-size: 0.75rem; color: #aaa; margin-bottom: 4px; }
  .summary-card .sublabel { font-size: 0.68rem; color: #777; margin-bottom: 6px; line-height: 1.4; }
  .summary-card .value { font-size: 1.4rem; font-weight: 700; }
  .gold { color: #ffd200; } .red { color: #ff6b6b; } .green { color: #51cf66; }

  .chart-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
  .chart-card h2 { font-size: 1rem; color: #ffd200; margin-bottom: 4px; }
  .chart-card .chart-sub { font-size: 0.75rem; color: #888; margin-bottom: 14px; }

  .warn-banner { background: rgba(255,80,80,0.15); border: 1px solid rgba(255,80,80,0.4); border-radius: 10px; padding: 12px 18px; color: #ff8080; font-size: 0.9rem; margin-bottom: 16px; display: none; }
  .surplus-box { background: rgba(116,192,252,0.08); border: 1px solid rgba(116,192,252,0.3); border-radius: 10px; padding: 10px 14px; margin-bottom: 16px; font-size: 0.82rem; color: #aac8f0; line-height: 1.7; }
  .surplus-box strong { color: #74c0fc; font-size: 1rem; }
  .footer { text-align: center; color: #555; font-size: 0.75rem; padding: 20px 0; }
  .divider { border: none; border-top: 1px solid rgba(255,255,255,0.08); margin: 12px 0; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ’€ ãƒ€ã‚¤ãƒ»ã‚¦ã‚£ã‚ºãƒ»ã‚¼ãƒ­</h1>
    <p>æ­»ã¬ã¨ãã«è³‡ç”£ã‚’ã‚¼ãƒ­ã«ã™ã‚‹ â€” äººç”Ÿã‚’æœ€å¤§é™ã«è±Šã‹ã«ä½¿ã†ãŸã‚ã®è¨ˆç®—ãƒ„ãƒ¼ãƒ«</p>
  </div>

  <div class="save-bar">
    <span class="save-toast" id="saveToast">âœ… URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¿å­˜ã—ã¦ãã ã•ã„</span>
    <button class="btn-save" onclick="saveData()">ğŸ’¾ ã‚»ãƒ¼ãƒ–ï¼ˆURLã«ä¿å­˜ï¼‰</button>
  </div>
  <div class="save-url-box" id="saveUrlBox">
    <div id="saveUrlText"></div>
    <button class="btn-copy" onclick="copyUrl()" style="margin-top:8px">ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼</button>
  </div>

  <div id="warnBanner" class="warn-banner"></div>
  <div class="surplus-box" id="surplusBox">è¨ˆç®—ä¸­...</div>

  <div class="summary">
    <div class="summary-card highlight">
      <div class="slabel">ğŸ¯ ä»Šæ—¥ã‹ã‚‰ä½¿ãˆã‚‹è‡ªç”±ãªãŠé‡‘</div>
      <div class="sublabel" id="dailySubLabel">å›ºå®šè²»ã‚’é™¤ã„ãŸä½™è£•è³‡é‡‘ã‚’<br>é‹ç”¨ã—ãªãŒã‚‰å¯¿å‘½ã§ã‚¼ãƒ­ã«ã™ã‚‹é¡</div>
      <div class="value gold" id="sumDaily">â€”</div>
      <div style="font-size:0.8rem;color:#ffd200;margin-top:2px">å††/æ—¥</div>
    </div>
    <div class="summary-card">
      <div class="slabel">ä½™è£•è³‡ç”£ã®çŠ¶æ³</div>
      <div class="sublabel" id="zeroSubLabel">å¯¿å‘½æ™‚ç‚¹ã®å›ºå®šè²»é™¤ãé‹ç”¨è³‡ç”£</div>
      <div class="value" id="sumZeroAge">â€”</div>
    </div>
    <div class="summary-card">
      <div class="slabel">ç”Ÿæ¶¯ç·åå…¥</div>
      <div class="sublabel">çµ¦ä¸ï¼‹å‰¯æ¥­ï¼‹å¹´é‡‘ã®åˆè¨ˆ</div>
      <div class="value green" id="sumTotalIncome">â€”</div>
      <div style="font-size:0.75rem;color:#888">å††</div>
    </div>
    <div class="summary-card">
      <div class="slabel">ç”Ÿæ¶¯å›ºå®šæ”¯å‡ºåˆè¨ˆ</div>
      <div class="sublabel">å®¶è³ƒãƒ»ç”Ÿæ´»è²»ãƒ»ç‰¹åˆ¥è²»ç­‰</div>
      <div class="value red" id="sumTotalExpense">â€”</div>
      <div style="font-size:0.75rem;color:#888">å††</div>
    </div>
  </div>

  <div class="grid">
    <!-- åŸºæœ¬æƒ…å ± -->
    <div class="card">
      <h2>ğŸ‘¤ åŸºæœ¬æƒ…å ±</h2>
      <div class="form-group">
        <label>ç¾åœ¨ã®å¹´é½¢ï¼ˆæ­³ï¼‰</label>
        <div class="input-wrap"><input class="plain-input" type="text" id="age" value="40"><span class="unit">æ­³</span></div>
      </div>
      <div class="form-group">
        <label>ğŸ’€ å¯¿å‘½å¹´é½¢ï¼ˆä½•æ­³ã¾ã§ç”Ÿãã‚‹ã‹ï¼‰</label>
        <div class="input-wrap"><input class="life-input" type="text" id="lifeAge" value="100"><span class="unit" style="color:#ff8080">æ­³</span></div>
      </div>
      <div class="form-group">
        <label>ç¾åœ¨ã®ç·è³‡ç”£ï¼ˆå††ï¼‰</label>
        <div class="input-wrap"><input class="comma-input" type="text" id="assets" value="10,000,000"><span class="unit">å††</span></div>
      </div>
      <div class="form-group">
        <label>è³‡ç”£é‹ç”¨åˆ©å›ã‚Šï¼ˆ%/å¹´ï¼‰</label>
        <div class="input-wrap"><input class="plain-input" type="text" id="returnRate" value="3"><span class="unit">%</span></div>
      </div>
    </div>

    <!-- åå…¥ -->
    <div class="card">
      <h2>ğŸ’° åå…¥</h2>
      <div class="form-group"><label>ç¾åœ¨ã®å¹´åï¼ˆå††/å¹´ï¼‰</label><div class="input-wrap"><input class="comma-input" type="text" id="annualIncome" value="6,500,000"><span class="unit">å††</span></div></div>
      <div class="form-group"><label>å°±åŠ´çµ‚äº†å¹´é½¢ï¼ˆæ­³ï¼‰</label><div class="input-wrap"><input class="plain-input" type="text" id="retireAge" value="65"><span class="unit">æ­³</span></div></div>
      <hr class="divider">
      <div class="form-group"><label>å¹´é‡‘å—çµ¦é–‹å§‹å¹´é½¢ï¼ˆæ­³ï¼‰</label><div class="input-wrap"><input class="plain-input" type="text" id="pensionStartAge" value="65"><span class="unit">æ­³</span></div></div>
      <div class="form-group"><label>å¹´é‡‘å—çµ¦é¡ï¼ˆå††/æœˆï¼‰</label><div class="input-wrap"><input class="comma-input" type="text" id="pensionMonthly" value="150,000"><span class="unit">å††</span></div></div>
      <div class="side-job-section">
        <h3>ğŸ’¼ å‰¯æ¥­åå…¥</h3>
        <div class="age-range">
          <div class="form-group"><label>å‰¯æ¥­ é–‹å§‹å¹´é½¢</label><div class="input-wrap"><input class="plain-input" type="text" id="sideStartAge" value="40"><span class="unit">æ­³</span></div></div>
          <div class="form-group"><label>å‰¯æ¥­ çµ‚äº†å¹´é½¢</label><div class="input-wrap"><input class="plain-input" type="text" id="sideEndAge" value="70"><span class="unit">æ­³</span></div></div>
        </div>
        <div class="form-group"><label>å‰¯æ¥­ã®å¹´åå…¥é¡ï¼ˆå††/å¹´ï¼‰</label><div class="input-wrap"><input class="comma-input" type="text" id="sideIncome" value="1,000,000"><span class="unit">å††</span></div></div>
      </div>
    </div>

    <!-- æ”¯å‡º -->
    <div class="card">
      <h2>ğŸ  æ¯æœˆã®å›ºå®šæ”¯å‡º</h2>
      <div class="form-group"><label>å®¶è³ƒãƒ»ä½å±…è²»ï¼ˆå††/æœˆï¼‰</label><div class="input-wrap"><input class="comma-input" type="text" id="rent" value="80,000"><span class="unit">å††</span></div></div>
      <div class="form-group"><label>æ¯æœˆã®ç”Ÿæ´»è²»ï¼ˆå††/æœˆï¼‰</label><div class="input-wrap"><input class="comma-input" type="text" id="living" value="150,000"><span class="unit">å††</span></div></div>
    </div>
    <div class="card">
      <h2>âœˆï¸ å¹´é–“ã®ç‰¹åˆ¥æ”¯å‡ºãƒ»ãã®ä»–</h2>
      <div class="form-group"><label>ç‰¹åˆ¥ãªå‡ºè²»ï¼ˆå††/å¹´ï¼‰</label><div class="input-wrap"><input class="comma-input" type="text" id="special" value="500,000"><span class="unit">å††</span></div></div>
      <div id="extraItems"></div>
      <button class="btn-add" onclick="addExtraItem()">ï¼‹ ãã®ä»–è²»ç›®ã‚’è¿½åŠ </button>
    </div>
  </div>

  <div class="chart-card">
    <h2>ğŸ“ˆ ä½™è£•è³‡ç”£ã®æ¨ç§»</h2>
    <div class="chart-sub" id="chartSub1">å›ºå®šè²»ãƒ»1æ—¥ä½¿ç”¨é¡ã‚’é™¤ã„ãŸé‹ç”¨è³‡ç”£ã®æ®‹é«˜ã€‚å¯¿å‘½å¹´é½¢ã§ã‚¼ãƒ­ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚</div>
    <canvas id="assetChart" height="80"></canvas>
  </div>
  <div class="chart-card">
    <h2>ğŸ“… å¹´é½¢åˆ¥ãƒ»1æ—¥ã‚ãŸã‚Šä½¿ãˆã‚‹è‡ªç”±ãªãŠé‡‘</h2>
    <div class="chart-sub">ãã®å¹´ã®ä½™è£•è³‡ç”£ã‚’æ®‹ã‚Šæ—¥æ•°ã§å‰²ã£ãŸã€Œ1æ—¥ã‚ãŸã‚Šã®è‡ªç”±ä½¿ç”¨å¯èƒ½é¡ã€ã®æ¨ç§»ã§ã™ã€‚</div>
    <canvas id="dailyChart" height="80"></canvas>
  </div>

  <div class="footer">â€» ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚å®Ÿéš›ã®ç¨é‡‘ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬ç­‰ã¯è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“ã€‚</div>
</div>

<script>
let extraItems = [], assetChart, dailyChart;

function toNum(id) {
  const el = document.getElementById(id);
  return el ? parseFloat(el.value.replace(/,/g, '')) || 0 : 0;
}
function formatComma(str) {
  const raw = str.replace(/,/g, '').replace(/[^\d]/g, '');
  return raw ? parseInt(raw, 10).toLocaleString('ja-JP') : '';
}
function attachComma(el) {
  if (!el) return;
  el.addEventListener('focus', function() { this.value = this.value.replace(/,/g, ''); });
  el.addEventListener('blur',  function() { if (this.value) this.value = formatComma(this.value); calculate(); });
  el.addEventListener('input', calculate);
}
document.querySelectorAll('.comma-input').forEach(attachComma);
document.querySelectorAll('.plain-input, .life-input').forEach(el => el.addEventListener('input', calculate));

function addExtraItem(name='', amount='') {
  extraItems.push({ id: Date.now(), name, amount });
  renderExtraItems();
  calculate();
}
function removeExtraItem(id) {
  extraItems = extraItems.filter(e => e.id !== id);
  renderExtraItems();
  calculate();
}
function renderExtraItems() {
  document.getElementById('extraItems').innerHTML = extraItems.map(e => `
    <div class="extra-item">
      <input type="text" class="name-input" placeholder="è²»ç›®å" id="ename-${e.id}" value="${e.name||''}" oninput="calculate()">
      <div class="comma-wrap">
        <input type="text" placeholder="0" id="eamt-${e.id}" value="${e.amount ? parseInt(e.amount).toLocaleString('ja-JP') : ''}"
          onfocus="this.value=this.value.replace(/,/g,'')"
          onblur="if(this.value)this.value=parseInt(this.value.replace(/,/g,'')).toLocaleString('ja-JP');calculate()"
          oninput="calculate()">
        <span class="unit">å††/å¹´</span>
      </div>
      <button class="btn-del" onclick="removeExtraItem(${e.id})">âœ•</button>
    </div>`).join('');
}

function fmt(n) {
  if (Math.abs(n) >= 1e8) return (n / 1e8).toFixed(1) + 'å„„';
  if (Math.abs(n) >= 1e4) return Math.round(n / 1e4) + 'ä¸‡';
  return Math.round(n).toLocaleString();
}

function calculate() {
  const ca      = toNum('age');
  const lifeAge = Math.max(toNum('lifeAge'), ca + 1); // æœ€ä½ã§ã‚‚ç¾åœ¨+1æ­³
  const a0      = toNum('assets');
  const rr      = toNum('returnRate') / 100;
  const ai      = toNum('annualIncome');
  const ra      = toNum('retireAge');
  const psa     = toNum('pensionStartAge');
  const pm      = toNum('pensionMonthly');
  const ss      = toNum('sideStartAge');
  const se      = toNum('sideEndAge');
  const si      = toNum('sideIncome');

  const extraTotal = extraItems.reduce((s, e) => {
    const el = document.getElementById('eamt-' + e.id);
    return s + (el ? parseFloat(el.value.replace(/,/g,'')) || 0 : 0);
  }, 0);
  const annualFixed = toNum('rent')*12 + toNum('living')*12 + toNum('special') + extraTotal;

  // äºŒåˆ†æ¢ç´¢ï¼šå¯¿å‘½å¹´é½¢ã§ã¡ã‚‡ã†ã©æ®‹é«˜ã‚¼ãƒ­ã«ãªã‚‹1æ—¥ä½¿ç”¨é¡Dã‚’æ±‚ã‚ã‚‹
  function simulate(dailySpend) {
    let bal = a0;
    const annualFree = dailySpend * 365;
    const balArr = [];
    let ti = 0, te = 0;
    for (let age = ca; age <= lifeAge; age++) {
      const inc = (age < ra ? ai : 0)
                + (age >= psa ? pm * 12 : 0)
                + (age >= ss && age <= se ? si : 0);
      bal = bal * (1 + rr) + inc - annualFixed - annualFree;
      ti += inc;
      te += annualFixed;
      balArr.push(Math.round(bal));
    }
    return { balArr, finalBal: bal, ti, te };
  }

  let lo = 0, hi = 1_000_000_000;
  for (let i = 0; i < 64; i++) {
    const mid = (lo + hi) / 2;
    simulate(mid).finalBal > 0 ? (lo = mid) : (hi = mid);
  }
  const optimalDaily = Math.floor((lo + hi) / 2);
  const { balArr, ti, te } = simulate(optimalDaily);

  // ã‚°ãƒ©ãƒ•ç”¨ãƒ‡ãƒ¼ã‚¿
  const ages = [], ad = [], dd = [];
  let za = null;
  for (let i = 0; i <= lifeAge - ca; i++) {
    const age = ca + i;
    const remDays = (lifeAge - age) * 365;
    ages.push(age + 'æ­³');
    ad.push(balArr[i]);
    dd.push(remDays > 0 ? Math.round(balArr[i] / remDays) : 0);
    if (balArr[i] < 0 && !za) za = age;
  }

  // åˆå¹´åº¦åæ”¯ã‚µãƒãƒªãƒ¼
  const fyInc = (ca < ra ? ai : 0) + (ca >= psa ? pm*12 : 0) + (ca >= ss && ca <= se ? si : 0);
  const fySurplus = fyInc - annualFixed;
  document.getElementById('surplusBox').innerHTML =
    `<b>ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦ï¼ˆå¯¿å‘½ï¼š${lifeAge}æ­³ï¼‰ï¼š</b><br>` +
    `ç¾åœ¨ã®å¹´é–“åå…¥ <strong>${fyInc.toLocaleString()}å††</strong> ï¼ ` +
    `å¹´é–“å›ºå®šæ”¯å‡º <strong>${annualFixed.toLocaleString()}å††</strong> ï¼ ` +
    `å¹´é–“åæ”¯å·® <strong style="color:${fySurplus>=0?'#51cf66':'#ff6b6b'}">${fySurplus>=0?'+':''}${fySurplus.toLocaleString()}å††</strong><br>` +
    `ç·è³‡ç”£ <strong>${a0.toLocaleString()}å††</strong> ã‚’åˆ©å›ã‚Š <strong>${toNum('returnRate')}%</strong> ã§é‹ç”¨ã—ãªãŒã‚‰ã€` +
    `å›ºå®šè²»ã‚’æ‰•ã„ç¶šã‘ã€<strong style="color:#ffd200">${lifeAge}æ­³ã§ã¡ã‚‡ã†ã©ã‚¼ãƒ­</strong>ã«ãªã‚‹ã‚ˆã†é€†ç®—ã—ã¦ã„ã¾ã™ã€‚`;

  // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã‚‚å¯¿å‘½å¹´é½¢ã«åˆã‚ã›ã¦æ›´æ–°
  document.getElementById('dailySubLabel').textContent = `å›ºå®šè²»ã‚’é™¤ã„ãŸä½™è£•è³‡é‡‘ã‚’é‹ç”¨ã—ãªãŒã‚‰${lifeAge}æ­³ã§ã‚¼ãƒ­ã«ã™ã‚‹é¡`;
  document.getElementById('zeroSubLabel').textContent  = `${lifeAge}æ­³æ™‚ç‚¹ã®å›ºå®šè²»é™¤ãé‹ç”¨è³‡ç”£`;
  document.getElementById('chartSub1').textContent     = `å›ºå®šè²»ãƒ»1æ—¥ä½¿ç”¨é¡ã‚’é™¤ã„ãŸé‹ç”¨è³‡ç”£ã®æ®‹é«˜ã€‚${lifeAge}æ­³ã§ã‚¼ãƒ­ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚`;

  document.getElementById('sumDaily').textContent = optimalDaily.toLocaleString();
  document.getElementById('sumTotalIncome').textContent  = fmt(ti);
  document.getElementById('sumTotalExpense').textContent = fmt(te);

  const ze = document.getElementById('sumZeroAge');
  const wb = document.getElementById('warnBanner');
  if (za) {
    ze.textContent = za + 'æ­³ã§ã‚¼ãƒ­'; ze.className = 'value red';
    wb.style.display = 'block';
    wb.textContent = `âš ï¸ ${za}æ­³ã§ä½™è£•è³‡ç”£ãŒã‚¼ãƒ­ã«ãªã‚Šã¾ã™ã€‚å›ºå®šæ”¯å‡ºã‚’è¦‹ç›´ã™ã‹ã€åå…¥ã‚’å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚`;
  } else {
    ze.textContent = lifeAge + 'æ­³ã§ â‰ˆ 0å††'; ze.className = 'value green';
    wb.style.display = 'none';
  }

  const sc = {
    x: { ticks:{color:'#888',maxTicksLimit:13,font:{size:11}}, grid:{color:'rgba(255,255,255,0.05)'} },
    y: { ticks:{color:'#888',font:{size:11}, callback: v => Math.abs(v)>=1e8?(v/1e8).toFixed(0)+'å„„':Math.abs(v)>=1e4?Math.round(v/1e4)+'ä¸‡':v }, grid:{color:'rgba(255,255,255,0.05)'} }
  };

  if (assetChart) assetChart.destroy();
  assetChart = new Chart(document.getElementById('assetChart'), {
    type:'line',
    data:{ labels:ages, datasets:[{ data:ad, borderColor:'#ffd200', backgroundColor:'rgba(255,210,0,0.08)', fill:true, tension:0.3, pointRadius:0, borderWidth:2 }]},
    options:{ responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{ legend:{display:false}, tooltip:{backgroundColor:'rgba(0,0,0,0.8)', callbacks:{label: c=>' ä½™è£•è³‡ç”£æ®‹é«˜: '+c.parsed.y.toLocaleString()+' å††'}}},
      scales:sc }
  });

  if (dailyChart) dailyChart.destroy();
  dailyChart = new Chart(document.getElementById('dailyChart'), {
    type:'line',
    data:{ labels:ages, datasets:[{ data:dd, borderColor:'#74c0fc', backgroundColor:'rgba(116,192,252,0.08)', fill:true, tension:0.3, pointRadius:0, borderWidth:2 }]},
    options:{ responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{ legend:{display:false}, tooltip:{backgroundColor:'rgba(0,0,0,0.8)', callbacks:{label: c=>' 1æ—¥ã®è‡ªç”±ä½¿ç”¨é¡: '+c.parsed.y.toLocaleString()+' å††'}}},
      scales:sc }
  });
}

// â”€â”€ ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ â”€â”€
function gatherData() {
  const extras = extraItems.map(e => ({
    name:   (document.getElementById('ename-'+e.id)||{}).value || '',
    amount: ((document.getElementById('eamt-'+e.id)||{}).value||'').replace(/,/g,'')
  }));
  return {
    age:            document.getElementById('age').value,
    lifeAge:        document.getElementById('lifeAge').value,
    assets:         toNum('assets'),
    returnRate:     document.getElementById('returnRate').value,
    annualIncome:   toNum('annualIncome'),
    retireAge:      document.getElementById('retireAge').value,
    pensionStartAge:document.getElementById('pensionStartAge').value,
    pensionMonthly: toNum('pensionMonthly'),
    sideStartAge:   document.getElementById('sideStartAge').value,
    sideEndAge:     document.getElementById('sideEndAge').value,
    sideIncome:     toNum('sideIncome'),
    rent:           toNum('rent'),
    living:         toNum('living'),
    special:        toNum('special'),
    extras
  };
}

function saveData() {
  const encoded = btoa(encodeURIComponent(JSON.stringify(gatherData())));
  const url = location.href.split('?')[0] + '?d=' + encoded;
  document.getElementById('saveUrlText').textContent = url;
  document.getElementById('saveUrlBox').classList.add('show');
  const doCopy = () => {
    if (navigator.clipboard) { navigator.clipboard.writeText(url).then(showToast); }
    else { const t=document.createElement('textarea'); t.value=url; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast(); }
  };
  doCopy();
}
function copyUrl() {
  const url = document.getElementById('saveUrlText').textContent;
  if (navigator.clipboard) { navigator.clipboard.writeText(url).then(showToast); }
  else { const t=document.createElement('textarea'); t.value=url; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast(); }
}
function showToast() {
  const t = document.getElementById('saveToast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function loadFromUrl() {
  const d = new URLSearchParams(location.search).get('d');
  if (!d) return;
  try {
    const data = JSON.parse(decodeURIComponent(atob(d)));
    const set  = (id, val) => { const el=document.getElementById(id); if(el) el.value=val; };
    const setC = (id, val) => { const el=document.getElementById(id); if(el) el.value=parseInt(val).toLocaleString('ja-JP'); };
    set('age', data.age);
    set('lifeAge', data.lifeAge ?? 100);   // æ—§ãƒ‡ãƒ¼ã‚¿äº’æ›
    setC('assets', data.assets);
    set('returnRate', data.returnRate);
    setC('annualIncome', data.annualIncome);
    set('retireAge', data.retireAge);
    set('pensionStartAge', data.pensionStartAge);
    setC('pensionMonthly', data.pensionMonthly);
    set('sideStartAge', data.sideStartAge);
    set('sideEndAge', data.sideEndAge);
    setC('sideIncome', data.sideIncome);
    setC('rent', data.rent);
    setC('living', data.living);
    setC('special', data.special);
    if (data.extras) data.extras.forEach(ex => addExtraItem(ex.name, ex.amount));
  } catch(e) { console.warn('ãƒ­ãƒ¼ãƒ‰å¤±æ•—', e); }
}

loadFromUrl();
calculate();
</script>
</body>
</html>
